<!--
 * Created by WebStorm
 * User:maomao,http://www.mmcode.top
 * Date:2017/4/17
 * Time:14:28
 -->

<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>大屏编辑</title>
    <link href="../css/jsoneditor.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="../css/bootstrap.css"/>
    <link rel="stylesheet" href="../css/index.css"/>
    <link rel="stylesheet" href="../css/DAT.GUI.css"/>
    <link rel="stylesheet" href="../css/jquery-ui.css">
    <link rel="stylesheet" href="../css/JSONFormatter.css">
    <link rel="stylesheet" href="../css/tooltipster.bundle.css">
    <link rel="stylesheet" href="../css/nprogress.css">
    <link rel="stylesheet" href="../css/bootstrap-slider.css">


    <script src="../js/jquery.js"></script>
    <script src="../js/DAT.GUI.js"></script>
    <script src="../js/tooltipHelp.js"></script>
    <script src="../js/tooltipster.bundle.js"></script>
    <script src="../js/echarts.js"></script>
    <script src="../js/hescEchartBarChart.js"></script>
    <script src="../js/hescEchartLineChart.js"></script>
    <script src="../js/hescEchartPieChart.js"></script>
    <script src="../js/hescEchartCalendarMapChart.js"></script>
    <script src="../js/hescEchartRadarChart.js"></script>
    <script src="../js/hescEchartWordCloudChart.js"> </script>
    <script src="../js/hescEchartCore.js"></script>
    <script src="../js/worldcloud.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/bootstrap-slider.js"></script>
    <script src="../js/ace.js"></script>
    <script src="../js/ajv.js"></script>
    <script src="../js/jsoneditor.js"></script>
    <script src="../js/fileReader.js"></script>
    <script src="../js/jquery-ui.min.js"></script>
    <script src="../js/jQuery-mutate-event.js"></script>
    <script src="../js/jQuery-mutate-mutate.js"></script>
    <script src="../js/hashids.js"></script>
    <script src="../js/index.js"></script>
    <script src="../js/renderChart.js"></script>
    <script src="../js/JSONFormatter.js"></script>
    <script src="../js/fileSaver.min.js"></script>
    <script src="../js/checkToken.js"></script>

    <script src="../js/nprogress.js"></script>
    <script src="../js/bootstrap-growl.js"></script>

    <script src="../js/ETheme/echartTheme.js"></script>
    <script src="../js/ETheme/chalk.js"></script>
    <script src="../js/ETheme/dark.js"></script>
    <script src="../js/ETheme/essos.js"></script>
    <script src="../js/ETheme/halloween.js"></script>
    <script src="../js/ETheme/infographic.js"></script>
    <script src="../js/ETheme/macarons.js"></script>
    <script src="../js/ETheme/purple-passion.js"></script>
    <script src="../js/ETheme/roma.js"></script>
    <script src="../js/ETheme/shine.js"></script>
    <script src="../js/ETheme/vintage.js"></script>
    <script src="../js/ETheme/walden.js"></script>
    <script src="../js/ETheme/westeros.js"></script>
    <script src="../js/ETheme/wonderland.js"></script>
    <script src="../js/D3.js"></script>
    <script src="../js/html2canvas.js"></script>
    <script src="../js/canvas-toBlob.js"></script>

</head>
<body>


<div class="navbar navbar-default navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="../html/index.html" class="navbar-brand">HESCharts</a>
            <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>
        <div class="navbar-collapse collapse" id="navbar-main">
            <ul class="nav navbar-nav" id="addChart">
                <li>
                    <a href="#" id="bar">柱状</a>
                </li>
                <li>
                    <a href="#" id="line">折线</a>
                </li>
                <li>
                    <a href="#" id="pie">饼图</a>
                </li>
                <li>
                    <a href="#" id="radar">雷达</a>
                </li>
                <li>
                    <a href="#" id="calendar">日历热图</a>
                </li>
                <li>
                    <a href="#" id="wordCloud">词云</a>
                </li>
            </ul>

            <!--&lt;!&ndash;header右侧&ndash;&gt;-->
            <!--<ul class="nav navbar-nav navbar-right">-->
                <!--<li><a href="heacEchartCases.html" target="_blank">案例集</a></li>-->
                <!--&lt;!&ndash;<li><a href="https://wrapbootstrap.com/?ref=bsw" target="_blank">WrapBootstrap</a></li>&ndash;&gt;-->
            <!--</ul>-->

            <!--测试保存数据按钮-->
            <ul class="nav navbar-nav navbar-right">
                <li><a href="javascript:updateScreenConfig(id)" target="_blank">保存</a></li>
                <!--<li><a href="https://wrapbootstrap.com/?ref=bsw" target="_blank">WrapBootstrap</a></li>-->
            </ul>


            <ul id="preview" class="nav navbar-nav navbar-right">
                <li><a href="javascript:previewScreenLoading(id)" >预览</a></li>
                <a id="previewHref" href="" style="display: none" target="_blank"><span id="previewHrefClick" ></span></a>
                <!--<li><a href="https://wrapbootstrap.com/?ref=bsw" target="_blank">WrapBootstrap</a></li>-->
            </ul>

            <ul id="downloadScreenshot" class="nav navbar-nav navbar-right">
                <li><a href="javascript:downloadScreenShot()" >保存截图</a></li>
                <!--<li><a href="https://wrapbootstrap.com/?ref=bsw" target="_blank">WrapBootstrap</a></li>-->
            </ul>




        </div>




    </div>
</div>
<div id="screenContainer" class="screenContainer">
    <div id="screen" class="screen">
        <!--隐藏的按钮用于输入input 的file-->
        <!--resize and drag div test-->
        <!--<div id='bar随即id' class="Monitor">-->
        <!--<div id="barChild" style="height:calc(100% - 3px);width:calc(100% - 3px);"></div>-->
        <!--</div>-->

    </div>



</div>


<div class="zoomScreen">
    <div style="text-align: center">

    <input id="ex6" type="text" data-slider-min="20" data-slider-max="200" data-slider-step="5" data-slider-value=""/>
    <span id="ex6CurrentSliderValLabel">当前缩放大小:<span id="ex6SliderVal"></span></span><span>%</span>
    </div>
</div>

<div class="tabs " >
    <ul id="myTab" class="nav nav-tabs">
        <li class="active" style="width: 50%" >
            <a href="#tabConfig" id="configTab" data-toggle="tab" style="text-align: center;">
                配置
            </a>
        </li>
        <li style="width: 50%;display: none;" id="dataTab"><a href="#tabData" style="text-align: center;" data-toggle="tab">数据</a></li>
    </ul>
    <div id="myTabContent1" class="tab-content" style="overflow-y:visible;">
        <div class="tab-pane fade in active" id="tabConfig">
        </div>
        <div class="tab-pane fade" id="tabData">
            <div id="dataDescription">
                <label>数据说明：</label>
                <!--数据说明待添加-->
            </div>


            <!--<input type="file" id="loadDocument" value="Load"/>-->
            <!--选择文件，静态文件，webAPI或者本地文件-->
                <ul id="myTab1" class="nav nav-tabs">

                    <li class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="false">
                            数据源类型 <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu" id="dataSource">
                            <li><a href="#dropdownstaticData" data-toggle="tab" aria-expanded="true">静态数据</a></li>
                            <li><a href="#dropdownWebAPI" data-toggle="tab" aria-expanded="false">Web API</a></li>
                            <li><a href="#dropdownLocalData" data-toggle="tab" aria-expanded="false">本地数据</a></li>
                        </ul>
                    </li>
                </ul>
                <div id="DataSourceSelector" class="tab-content">
                    <!--静态文件-->
                    <div class="tab-pane fade in active" id="dropdownstaticData">
                    </div>
                    <!--WebAPI-->
                    <div class="tab-pane fade" id="dropdownWebAPI">
                            <div class="form-group">
                                <label >WebAPI地址：</label>
                                <input type="text" class="form-control" id="webAPIUrl"
                                       placeholder="请输入URL，如http://example.com/API" style="width: 310px;height: 40px;">
                            </div>
                            <button type="submit" class="btn btn-default" style="width: 310px" id="webAPIButton">确定</button>
                    </div>
                    <!--本地文件-->
                    <div class="tab-pane fade" id="dropdownLocalData">
                        <form role="form">
                            <div class="form-group">
                                <label >本地文件：</label>
                                <!--<div class="tab-pane fade" id="tabData">-->
                                <input type="file" id="loadLocalData" value="Load"/>
                                <!--</div>-->
                            </div>
                        </form>
                    </div>
                </div>
            <ul class="nav nav-list">
                <li class="divider"></li>
            </ul>
                <!--添加jsoneditor模块-->
                <div id="jsonEditorData" style="width: 310px; height: 400px;">
                    <!--<input type="file" id="loadDocument" value="Load"/>-->
                </div>

            <!--json格式错误的提示-->
            <div id="jsoneditorWarning" style="background: #ffef8b;color:black;font-size: 10px;visibility: hidden;"><table class="jsoneditor-text-errors"><tbody><tr><td><button class="jsoneditor-schema-error"></button></td><td id='jsonerror'></td></tr></tbody></table></div>



            <button type="submit" class="btn btn-default" id="submitData" style="width: 310px">确定</button>
        </div>
    </div>
</div>

<!--隐藏的图片输入框-->
<input id="imgFileInput" type="file" style="display: none"/>

<!--下载option的模态框-->
<div class="modal fade" id="downloadOptionModal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true" >
    <div class="modal-dialog" style="height: 700px;width:500px;z-index: 1001;">

        <div class="modal-content">
            <div class="modal-header" style="display: block">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <p><配置文件></配置文件>（Echart的Option）</p>
            </div>
            <div class="modal-body">
                <form role="form">
                    <div class="form-group">
                        <textarea class="form-control" rows="25"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-block btn-sm" id="downloadHTMLToLocal">下载HTML</button>
            </div>
        </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>


<!--大屏删除确认的的模态框-->
<div class="modal fade" id="deleteScreenModal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true" style="top:20%;">
    <div class="modal-dialog" style="height: 700px;width:500px;z-index: 1001;">

        <div class="modal-content">
            <div class="modal-header" style="display: block">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <p>删除组件</p>
            </div>
            <div class="modal-body" style="text-align: center">
                <span class="glyphicon glyphicon-alert" style="display: block;font-size: 40px;color:#d62c1a" aria-hidden="true"></span>
                <label>组件删除后无法恢复，确认删除？</label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-sm" style="width: 15%" data-dismiss="modal" id="cancelDeleteScreenModalButton">取消</button>
                <button type="button" class="btn-sm btn-danger" style="width: 15%" data-dismiss="modal" id="deleteScreenModalButton">删除</button>
            </div>
        </div>
    </div><!-- /.modal-content -->
</div><!-- /.modal -->

<!--大屏预览模态框-->
<div class="modal fade" id="previewScreenModal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true" style="top:20%;">
    <div class="modal-dialog" style="height: 700px;width:500px;z-index: 1001;">

        <div class="modal-content">
            <div class="modal-body" style="text-align: center">
                <img src="../css/img/previewLoading.gif">
                <label>生成预览中</label>
            </div>
            </div>
        </div>
    </div><!-- /.modal-content -->
</div><!-- /.modal -->



<!--读取screen高度、计算缩放系数-->
<!--初始化tab的高度-->
<script>
    //定义id防止用户进行修改
    var id=getQueryString('id');



    //初始化nprogress
    (function () {
//        $('#preview a').each(function (i,d) {
//            if($(d).attr('href')!='#') {
//                $(d).attr('href', './hescEchartForPreView.html?id=' + id);
//            };
//        });


        //初始化nprpgress
        NProgress.configure({ parent: '#screenContainer' });
        NProgress.inc(0.4);
        setTimeout("NProgress.done(true)",3000);

    })();

    window.onbeforeunload = function(){
        return "您的文章尚未保存！";
    }
    //每次在页面编辑初始化的时候，检测是否添加了datGui的属性，如果添加了datGui的属性则向已经保存的配置中添加新属性
    function updateDatGuiConfigOnLoad(updateHescList){
        for(var i in updateHescList){
            var chartType=(updateHescList[i].divId).split('-');
            if(chartType[0]=='bar'){
                updateHescList[i].datGuiConfig=$.extend({},barInitialDatGuiData,updateHescList[i].datGuiConfig);
            }
            else if(chartType[0]=='line'){
                updateHescList[i].datGuiConfig=$.extend({},lineInitialDatGuiData,updateHescList[i].datGuiConfig);
            }
            else if(chartType[0]=='radar'){
                updateHescList[i].datGuiConfig=$.extend({},radarInitialDatGuiData,updateHescList[i].datGuiConfig);
            }
            else if(chartType[0]=='pie'){
                updateHescList[i].datGuiConfig=$.extend({},pieInitailDatGuiData,updateHescList[i].datGuiConfig);
            }
            else if(chartType[0]=='calendar'){
                updateHescList[i].datGuiConfig=$.extend({},calendarInitialDatGuiData,updateHescList[i].datGuiConfig);
            }
            else if(chartType[0]=='wordCloud'){
                updateHescList[i].datGuiConfig=$.extend({},wordCloudInitialDatGuiData,updateHescList[i].datGuiConfig);
            }
        }
        return updateHescList;
    }


    $(function () {
        $.ajax({
            type:"get",
            dataType:"json",
            url:serviceBaseUrl+'/ajax/screen/find/config',
            data:{id:id},
            headers:{
                token:localStorage.getItem("token")//将token放到请求头中
            },
            success:function(d){
                checkSuccessStatus(d);
//                console.log(d.hescList);
//                console.log(d.gridConfig);

                //根据初始化的控制面板去更新hesclist的属性信息
                hescList=updateDatGuiConfigOnLoad(d.hescList);

                addScreenByShare();
                addScreenDatGui();
                refreshTransformScale();
                updateZoomDiv();
                //根据gridConfig的divId创建div和生成图形
                for(var i=0;i<d.gridConfig.length;i++){
                    //排除gridConfig里面的screen的配置
                    if((d.gridConfig)[i].divId!='screen') {
                        //添加图形的div
                        addChartDivByShare($('#screen'), (d.gridConfig)[i].divId);
                        //绘制图形和dat.gui
                        addDatGuiAndRenderChartAndCssSettingByShare((d.gridConfig[i]).divId);
                        //移动图形到合适的位置(动画)
                        $('#'+(d.gridConfig)[i].divId)
                            .css('top',$('#screen').height()*1/4)
                            .css('left',$('#screen').width()*1/4);
                        d3.select('#'+(d.gridConfig)[i].divId)
                            .transition()
                            .duration(3000)
                            .style('top',(d.gridConfig)[i].style.replace(/[\s\S]*top:([\s\S]*?);[\s\S]*/g,'$1'))
                            .style('left',(d.gridConfig)[i].style.replace(/[\s\S]*left:([\s\S]*?);[\s\S]*/g,'$1'));
                    }
                }
                //清除所有的div选中状态，即控制面板默认为screen的配置
                addScreenDatGui();
                $('#screen .divControlPannel').each(function () {
                    $(this).css('display','none')
                });
                /*
                 *清除所有div的边框
                 */
                $('.Monitor').each(function () {
                    $(this).css("outline",'');
                });
            },
            error:function () {
              alert('权限非法！请编辑自己的可视化大屏！');
                window.onbeforeunload=function(){};
              location.href='../html/index.html';
            }
        });

    });

    $('.tabs').height($(window).height()-60);




    /*
     添加词云的本地文件
     */
    FileReaderJS.setupInput(document.getElementById('imgFileInput'), {
        on: {
            load: function (event, file) {
//                editor.setText(event.target.result);
                wordCloudObj.maskImage=event.target.result;
            },
            loadend:function () {
                renderWordCloudChart();
            }
        }
    });
</script>

<!----------------------------------------------------JS-------------------------------------------------------->
<!--1.初始化添加图形-->
<!--2.读取配置添加图形-->
<!--3.在screen上面点击图形时候的操作及css变化-->
<!--4.数据源提交的时候的变化-->
<script>
    //点击下载html的动作
    $('#downloadHTMLToLocal').click(function (e) {
        var file = new File([downloadOptionFun()], "HESCharts.html", {type: "text/html;charset=utf-8"});
        saveAs(file);
    })
    //顶端的添加图形按钮,点击按钮也是一种screen上面的点击行为，点击的div可以直接被选中
    $('#addChart').click(function (e) {
        var addChartEle=$(e.target).attr('id');
        addDatGuiAndRenderChartAndCSSSettingInitial(addChartEle);
    });
    //初始化添加datGUI、渲染图形、css设置
    function addDatGuiAndRenderChartAndCSSSettingInitial(addChartEle) {
        //显示数据tab
        $('#dataTab').css('display','block');

        if(addChartEle=='bar'){
            var chartId=addChartDiv($('#screen'),'bar');
            addBarDatGui(chartId);
            divChartId=chartId;
            jsonEditorEditor.set(findCanvasDataById(divChartId).data);
            jsonEditorEditor.setSchema(jsonSchema.barSchema);

        }
        else if(addChartEle=='line'){
            var chartId=addChartDiv($('#screen'),'line');
            addLineDatGui(chartId);
            divChartId=chartId;
            jsonEditorEditor.set(findCanvasDataById(divChartId).data);
            jsonEditorEditor.setSchema(jsonSchema.lineSchema);

        }
        else if(addChartEle=='radar'){
            var chartId=addChartDiv($('#screen'),'radar');
            addRadarDatGui(chartId);
            divChartId=chartId;
            jsonEditorEditor.set(findCanvasDataById(divChartId).data);
            jsonEditorEditor.setSchema(jsonSchema.radarSchema);

        }
        else if(addChartEle=='calendar'){
            var chartId=addChartDiv($('#screen'),'calendar');
            addCalendarDatGui(chartId);
            divChartId=chartId;
            jsonEditorEditor.set(findCanvasDataById(divChartId).data);
            jsonEditorEditor.setSchema(jsonSchema.calendarSchema);

        }
        else if(addChartEle=='pie'){
            var chartId=addChartDiv($('#screen'),'pie');
            addPieDatGui(chartId);
            divChartId=chartId;
            jsonEditorEditor.set(findCanvasDataById(divChartId).data);
            jsonEditorEditor.setSchema(jsonSchema.pieSchema);

        }
        else if(addChartEle=='wordCloud'){
            var chartId=addChartDiv($('#screen'),'wordCloud');
            addWordCloudDatGui(chartId);
            divChartId=chartId;
            jsonEditorEditor.set(findCanvasDataById(divChartId).data);
            jsonEditorEditor.setSchema(jsonSchema.wordCloudSchema);

        }

        /*
         样式更新
         */
        //用户选择时，打开该div的控制面板(控制面板是打开textarea或者是关闭div)
        //首先清除其他控制面板
        $('#screen .divControlPannel').each(function () {
            $(this).css('display','none')
        });
        //然后打开指定id的div的控制面板
        $('#'+divChartId+' .divControlPannel').each(function (e1) {
            $(this).css('display','inline');
        });

        /*
         *更新div的选中情况的边框情况
         */
        $('.Monitor').each(function () {
            $(this).css("outline",'');
        });
        $('#'+divChartId).css("outline",'1px solid #419bf9');
    };
    //读取配置添加datgui、渲染图形、css设置
    function addDatGuiAndRenderChartAndCssSettingByShare(divId) {
        //显示数据tab
        $('#dataTab').css('display','block');

        var addChartEle=divId.split('-');
        if(addChartEle[0]=='bar'){
            var chartId=addChartEle[0];
            addBarDatGui(divId);
            divChartId=divId;
            jsonEditorEditor.set(findCanvasDataById(divChartId).data);
            jsonEditorEditor.setSchema(jsonSchema.barSchema);
        }
        else if(addChartEle[0]=='line'){
            var chartId=addChartEle[0];
            addLineDatGui(divId);
            divChartId=divId;
            jsonEditorEditor.set(findCanvasDataById(divChartId).data);
            jsonEditorEditor.setSchema(jsonSchema.lineSchema);

        }
        else if(addChartEle[0]=='radar'){
            var chartId=addChartEle[0];
            addRadarDatGui(divId);
            divChartId=divId;
            jsonEditorEditor.set(findCanvasDataById(divChartId).data);
            jsonEditorEditor.setSchema(jsonSchema.radarSchema);

        }
        else if(addChartEle[0]=='calendar'){
            var chartId=addChartEle[0];
            addCalendarDatGui(divId);
            divChartId=divId;
            jsonEditorEditor.set(findCanvasDataById(divChartId).data);
            jsonEditorEditor.setSchema(jsonSchema.calendarSchema);

        }
        else if(addChartEle[0]=='pie'){
            var chartId=addChartEle[0];
            addPieDatGui(divId);
            divChartId=divId;
            jsonEditorEditor.set(findCanvasDataById(divChartId).data);
            jsonEditorEditor.setSchema(jsonSchema.pieSchema);

        }
        else if(addChartEle[0]=='wordCloud'){
            var chartId=addChartEle[0];
            addWordCloudDatGui(divId);
            divChartId=divId;
            jsonEditorEditor.set(findCanvasDataById(divChartId).data);
            jsonEditorEditor.setSchema(jsonSchema.wordCloudSchema);

        }

        /*
         样式更新
         */
        //用户选择时，打开该div的控制面板(控制面板是打开textarea或者是关闭div)
        //首先清除其他控制面板
        $('#screen .divControlPannel').each(function () {
            $(this).css('display','none')
        });
        //然后打开指定id的div的控制面板
        console.log('#'+divChartId)
        $('#'+divChartId+' .divControlPannel').each(function (e1) {
            $(this).css('display','inline');
        });

        /*
         *更新div的选中情况的边框情况
         */
        $('.Monitor').each(function () {
            $(this).css("outline",'');
        });
        $('#'+divChartId).css("outline",'1px solid #419bf9');
    }



    /*
     *选择screencontainer时候的dat.gui
     */
    $('#screenContainer').click(function (e) {
        if($(e.target).attr('id')=='screenContainer'){
            //隐藏数据tab
            $('#configTab').click();
            $('#dataTab').css('display', 'none');

            addScreenDatGui();
            /*
             更新样式
             */
            //首先清除其他控制面板
            $('#screen .divControlPannel').each(function () {
                $(this).css('display','none')
            });
            /*
             *清除所有div的边框
             */
            $('.Monitor').each(function () {
                $(this).css("outline",'');
            });

        }
    });


    /*
    screen上面的点击
     */
    $('#screen').click(function (e) {
        //判断是否是canvas的点击
        console.log($(e.target).attr('id'))
        if($(e.target).attr('id')=='downloadOption'||$(e.target).attr('id')=='removediv'||$(e.target).attr('id')=='screen'){
            //显示数据tab
            if($(e.target).attr('id')=='screen') {
                $('#configTab').click();
                $('#dataTab').css('display', 'none');
            }
            return;
        }
        else {
            //显示数据tab
            $('#dataTab').css('display','block');

            //divchartId全局变量之一，在Index.js中声明，获取用户选择的div的id
            //这里是获取到divchartid即为div的唯一的id，根据id之间有-判断是否是id

            divChartId=getDivChartId(e.target);

//            divChartId = $(e.target).parent().parent().parent().attr('id');
            //根据screen上面的点击id，刷新dat.gui内容和图形
            screenClick(divChartId);
            //更新canvasData
            jsonEditorEditor.set(addCanvasData(divChartId).data);

            /*
            *更新div的层叠关系
            * update:2017.5.3
            */
            //其他层级为1
            $('.Monitor').each(function () {
                $(this).css('z-index',1);
            });
            //选中的层级为10
            $('#'+divChartId).css('z-index',10);


            /*
            *更新div的选中情况的边框情况
            */
            $('.Monitor').each(function () {
                $(this).css("outline",'');
            });
            $('#'+divChartId).css("outline",'1px solid #419bf9');
        }
        /*
        样式更新
         */
        //用户选择时，打开该div的控制面板
        //首先清除其他控制面板
        $('#screen .divControlPannel').each(function () {
            $(this).css('display','none')
        });
        //然后打开指定id的div的控制面板
        $('#'+divChartId+' .divControlPannel').each(function (e1) {
            $(this).css('display','inline');
        });

    });
    //根据screen上面的点击内容，更新dat.gui和图形图形
    function screenClick(divChartId1){
        var divChartIdSplit=divChartId1.split('-');
        if(divChartIdSplit[0]=='bar'){
            addBarDatGui(divChartId1);
            jsonEditorEditor.setSchema(jsonSchema.barSchema);

        }
        else if(divChartIdSplit[0]=='line'){
            addLineDatGui(divChartId1);
            jsonEditorEditor.setSchema(jsonSchema.lineSchema);

        }
        else if(divChartIdSplit[0]=='pie'){
            addPieDatGui(divChartId1);
            jsonEditorEditor.setSchema(jsonSchema.pieSchema);

        }
        else if(divChartIdSplit[0]=='radar'){
            addRadarDatGui(divChartId1);
            jsonEditorEditor.setSchema(jsonSchema.radarSchema);

        }
        else if(divChartIdSplit[0]=='calendar'){
            addCalendarDatGui(divChartId1);
            jsonEditorEditor.setSchema(jsonSchema.calendarSchema);

        }
        else if(divChartIdSplit[0]=='wordCloud'){
            addWordCloudDatGui(divChartId1);
            jsonEditorEditor.setSchema(jsonSchema.wordCloudSchema);

        }

    }
    $('#submitData').click(function () {
        updateHescEleByIdToCanvasData(divChartId,JSON.parse(jsonEditorEditor.getText()));
        //借用addBarDatGui的方法更新绘图区数据
        console.log('我click:'+divChartId)
        screenClick(divChartId)
    });
    //根据屏幕上的点击获取divChartId，根据class是否为monitor判断是否为id
    function getDivChartId(target) {
        if($(target).attr('class')!=undefined&&$(target).attr('class').indexOf('Monitor')>=0){
            return $(target).attr('id');
        }
        else{
           return getDivChartId($(target).parent());
        }
    }

</script>

<!--jsonEditor对应的数据-->
<script>

    var jsonSchema={
        barSchema:{
            "type":"array",
            "items": {
                "type": "array",
                "items":{
                    "type":"object",
                    "properties":{
                        "x": {
                            "type":["string","number"]
                        },
                        "y":{
                            "type":["string","number"]
                        }
                    },
                    "required": ["x", "y"],
                    "additionalProperties":false
                }
            }
        },
        lineSchema:{
            "type":"array",
            "items": {
                "type": "array",
                "items":{
                    "type":"object",
                    "properties":{
                        "x": {
                            "type":["string","number"]
                        },
                        "y":{
                            "type":["string","number"]
                        }
                    },
                    "required": ["x", "y"],
                    "additionalProperties":false
                }
            }
        },
        pieSchema:{
            "type": "array",
            "items":{
                "type":"object",
                "properties":{
                    "name": {
                        "type":["string","number"]
                    },
                    "value":{
                        "type":["string","number"]
                    }
                },
                "required": ["name", "value"],
                "additionalProperties":false
            }
        },
        radarSchema:{
            "type":"array",
            "items": {
                "type": "array",
                "items":{
                    "type":"object",
                    "properties":{
                        "x": {
                            "type":["string","number"]
                        },
                        "y":{
                            "type":["string","number"]
                        }
                    },
                    "required": ["x", "y"],
                    "additionalProperties":false
                }
            }
        },
        calendarSchema:{

        },
        wordCloudSchema:{

        }
    }
    var ajv = new Ajv();


    var jsonEditorOptions = {
        mode: 'code',
        modes: [ 'code','text', 'tree', 'view'], // allowed modes
        onError: function (err) {
            alert(err.toString());
        },
        onModeChange: function (newMode, oldMode) {
            console.log('Mode switched from', oldMode, 'to', newMode);
        },
        schema:null,
        // show_errors:"always",
        ace: ace,
        // ajv:ajv,
        ajv: Ajv({ allErrors: true, verbose: true }),
        onChange:function(e){
            try{
                jsonEditorEditor.get();
                $('#jsoneditorWarning').css('visibility','hidden');
            }catch(err){
                var error=String(err).split('\n');
                $('#jsoneditorWarning').css('visibility','visible');
                $('#jsoneditorWarning #jsonerror').text("JSON error！"+(error[0].slice(error[0].indexOf("on "))+error[1].replace(/\s/g,'')));

            }
        }
    };
    var jsonEditorJson=[[{"2011":2},{"2011":4},{"2011":4},{"2011":4}],[{"2012":6},{"2012":8},{"2013":4},{"2013":4}],[{"2014":5},{"2014":2},{"2014":9},{"2014":1}],[{"2015":8},{"2015":6},{"2015":1},{"2015":7}]];
    var jsonEditorEditor=new JSONEditor(document.getElementById('jsonEditorData'),jsonEditorOptions);

    $('#dataSource a[data-toggle="tab"]').on('shown.bs.tab',function(e){
        if($(e.target).attr('href')=='#dropdownstaticData'){
            //将默认值赋值给jsoneditor
            //jsonEditorEditor.set(jsonEditorJson);
        }
        else if($(e.target).attr('href')=='#dropdownLocalData') {
            // Load a JSON document
            FileReaderJS.setupInput(document.getElementById('loadLocalData'), {
                readAsDefault: 'Text',
                on: {
                    load: function (event, file) {
                        jsonEditorEditor.setText(event.target.result);
                    }
                }
            });
        }
        });
    $('#webAPIButton').click(function () {

        $.ajax({
            type: "get",
            dataType: "json",
            url: serviceBaseUrl + '/webapiproxy/ajax/proxy',
            data: {url: $('#webAPIUrl').val()},
            headers: {
                token: localStorage.getItem("token")//将token放到请求头中
            },
            success: function (d) {
                checkSuccessStatus(d);
                jsonEditorEditor.setText(d);
            }
        });
    });


</script>



<!--缩放的slider-->
<script>

    function  updateZoomDiv() {

        var slider = new Slider('#ex6', {
            value: transformScale * 100,
            formatter: function (value) {
                return '当前缩放大小:' + value + '%';
            }
        });
        $('#ex6SliderVal').text((transformScale*100).toFixed(0));

        $("#ex6").on("slide", function (slideEvt) {
            $("#ex6SliderVal").text(slideEvt.value);
            $('#screen').css('transform', 'scale(' + slideEvt.value / 100 + ')');
            transformScale=slideEvt.value/100;
            console.log(slideEvt.value / 100);
        });
    }


</script>
</body>
</html>